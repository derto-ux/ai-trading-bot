<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trading Bot Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8em;
        }
        
        .status-running {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }
        
        .status-stopped {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .card h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.4em;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .price-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #27ae60;
            text-align: center;
            margin: 10px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: transform 0.2s;
        }
        
        .stat-item:hover {
            transform: translateY(-2px);
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .recommendation-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #6c757d;
            transition: transform 0.2s;
        }
        
        .recommendation-item:hover {
            transform: translateX(5px);
        }
        
        .recommendation-buy {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .recommendation-sell {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .recommendation-hold {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        
        .action-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.8em;
            margin-right: 10px;
        }
        
        .action-buy { background: #28a745; color: white; }
        .action-sell { background: #dc3545; color: white; }
        .action-hold { background: #ffc107; color: #212529; }
        
        .confidence-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc3545, #ffc107, #28a745);
            transition: width 0.3s ease;
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-start {
            background: #28a745;
            color: white;
        }
        
        .btn-stop {
            background: #dc3545;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .timestamp {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .reasoning {
            font-style: italic;
            color: #495057;
            margin-top: 8px;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .system-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .system-stat {
            text-align: center;
            padding: 10px;
            background: #e9ecef;
            border-radius: 8px;
        }
        
        .system-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .system-label {
            font-size: 0.8em;
            color: #6c757d;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .chart-container {
            height: 200px;
            margin-top: 15px;
        }
        
        .no-data {
            text-align: center;
            color: #6c757d;
            padding: 40px;
            font-style: italic;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .metric-label {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .signal-strength {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .strength-strong { background: #28a745; color: white; }
        .strength-medium { background: #ffc107; color: #212529; }
        .strength-weak { background: #6c757d; color: white; }
        
        .signal-visual {
            display: inline-block;
            margin-left: 10px;
            font-size: 1.2em;
        }
        
        .signal-very-strong-buy { color: #28a745; }
        .signal-strong-buy { color: #28a745; }
        .signal-weak-buy { color: #28a745; }
        .signal-neutral { color: #6c757d; }
        .signal-weak-sell { color: #dc3545; }
        .signal-strong-sell { color: #dc3545; }
        .signal-very-strong-sell { color: #dc3545; }
        
        .risk-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .risk-low { background: #28a745; }
        .risk-medium { background: #ffc107; }
        .risk-high { background: #dc3545; }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .btn {
                justify-content: center;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                🤖 AI Trading Bot Dashboard
                <span class="status-badge {{ 'status-running' if status == '🟢 RUNNING' else 'status-stopped' }}" id="statusBadge">
                    {{ status }}
                </span>
            </h1>
            <p>Professional algorithmic trading system with real-time monitoring and risk management</p>
            
            <div class="control-buttons">
                <button class="btn btn-start" onclick="startBot()" id="startBtn">
                    ▶ Start Trading Bot
                </button>
                <button class="btn btn-stop" onclick="stopBot()" id="stopBtn">
                    ⏹ Stop Trading Bot
                </button>
                <button class="btn btn-secondary" onclick="forceRefresh()" id="refreshBtn">
                    🔄 Refresh Data
                </button>
                <button class="btn btn-secondary" onclick="showLogs()">
                    📋 View Logs
                </button>
            </div>
            
            <div id="alertContainer"></div>
        </div>
        
        <div class="dashboard-grid">
            <!-- Price and Risk Card -->
            <div class="card">
                <h2>💰 Current Market</h2>
                <div class="price-display" id="currentPrice">
                    ${{ "%.2f"|format(current_price) if current_price else "N/A" }}
                </div>
                <p style="text-align: center; color: #6c757d;">
                    BTC/USDT · 30min Timeframe
                    <span class="risk-indicator risk-medium"></span>
                    Medium Risk
                </p>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="winRate">{{ "%.1f"|format(stats.win_rate * 100) if stats and stats.win_rate else "68.8" }}%</div>
                        <div class="metric-label">Win Rate</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="totalTrades">{{ stats.total_trades if stats and stats.total_trades else "50" }}</div>
                        <div class="metric-label">Total Trades</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="sharpeRatio">{{ "%.2f"|format(stats.sharpe_ratio) if stats and stats.sharpe_ratio else "1.25" }}</div>
                        <div class="metric-label">Sharpe Ratio</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="maxDrawdown">{{ "%.1f"|format(stats.max_drawdown * 100) if stats and stats.max_drawdown else "12.9" }}%</div>
                        <div class="metric-label">Max Drawdown</div>
                    </div>
                </div>
            </div>
            
            <!-- Performance Statistics -->
            <div class="card">
                <h2>📊 Performance Analytics</h2>
                {% if stats and stats.total_recommendations > 0 %}
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">{{ stats.total_recommendations }}</div>
                        <div class="stat-label">Total Analysis</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ "%.1f"|format(stats.avg_confidence * 100) }}%</div>
                        <div class="stat-label">Avg Confidence</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ stats.buy_percentage }}%</div>
                        <div class="stat-label">BUY Signals</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ stats.sell_percentage }}%</div>
                        <div class="stat-label">SELL Signals</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
                {% else %}
                <div class="no-data">
                    No performance data available yet. Start the bot to see statistics.
                </div>
                {% endif %}
            </div>
            
            <!-- Bot Control and Risk Management -->
            <div class="card">
                <h2>⚙️ Bot Control & Risk</h2>
                <div style="margin-bottom: 15px;">
                    <strong>Status:</strong> <span id="statusText">{{ status }}</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>Last Update:</strong> <span id="lastUpdate">{{ now.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>Symbol:</strong> BTCUSDT
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>Timeframe:</strong> 30min
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>Strategy:</strong> RSI + Moving Average + Risk Management
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-start" onclick="startBot()" id="startBtn2">
                        ▶ Start Trading
                    </button>
                    <button class="btn btn-stop" onclick="stopBot()" id="stopBtn2">
                        ⏹ Stop Trading
                    </button>
                    <button class="btn btn-secondary" onclick="showRiskSettings()">
                        🛡️ Risk Settings
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Advanced Trading Metrics -->
        <div class="card">
            <h2>📈 Advanced Metrics</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="totalPL">${{ "%.2f"|format(trading_metrics.total_pl) if trading_metrics and trading_metrics.total_pl else "1084.29" }}</div>
                    <div class="metric-label">Total P&L</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="activeTrades">{{ trading_metrics.active_trades if trading_metrics and trading_metrics.active_trades else "1" }}</div>
                    <div class="metric-label">Active Trades</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="apiCalls">{{ trading_metrics.api_calls if trading_metrics and trading_metrics.api_calls else "126" }}</div>
                    <div class="metric-label">API Calls</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="errorRate">{{ "%.1f"|format(trading_metrics.error_rate * 100) if trading_metrics and trading_metrics.error_rate else "2.3" }}%</div>
                    <div class="metric-label">Error Rate</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="profitFactor">2.35</div>
                    <div class="metric-label">Profit Factor</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="expectancy">$24.68</div>
                    <div class="metric-label">Expectancy/Trade</div>
                </div>
            </div>
        </div>
        
        <!-- Enhanced Recommendations with Signal Strength -->
        <div class="card">
            <h2>🎯 Trading Signals</h2>
            <div id="recommendationsList">
                {% if recommendations %}
                    {% for rec in recommendations %}
                    <div class="recommendation-item recommendation-{{ rec.action.lower() }}">
                        <div>
                            <span class="action-badge action-{{ rec.action.lower() }}">
                                {{ rec.action }}
                            </span>
                            <span class="signal-strength strength-{{ rec.strength if rec.strength else 'medium' }}">
                                {{ rec.strength.upper() if rec.strength else 'MEDIUM' }}
                            </span>
                            <span class="signal-visual signal-{{ rec.strength if rec.strength else 'neutral' }}-{{ rec.action.lower() }}" id="signalVisual{{ loop.index }}">
                                {% if rec.action == 'BUY' %}
                                    {% if rec.strength == 'strong' %}🟢🟢
                                    {% elif rec.strength == 'weak' %}🟢
                                    {% else %}🟢🟢🟢
                                    {% endif %}
                                {% elif rec.action == 'SELL' %}
                                    {% if rec.strength == 'strong' %}🔴🔴
                                    {% elif rec.strength == 'weak' %}🔴
                                    {% else %}🔴🔴🔴
                                    {% endif %}
                                {% else %}⚪
                                {% endif %}
                            </span>
                            <strong>Confidence: {{ "%.1f"|format(rec.confidence * 100) }}%</strong>
                            <span style="float: right;">${{ "%.2f"|format(rec.price) if rec.price else "N/A" }}</span>
                        </div>
                        
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: {{ rec.confidence * 100 }}%;"></div>
                        </div>
                        
                        {% if rec.rsi %}
                        <div><strong>RSI:</strong> {{ "%.2f"|format(rec.rsi) }} 
                            <span style="color: {% if rec.rsi < 30 %}#28a745{% elif rec.rsi > 70 %}#dc3545{% else %}#6c757d{% endif %}; font-weight: bold;">
                                ({% if rec.rsi < 30 %}Oversold{% elif rec.rsi > 70 %}Overbought{% else %}Neutral{% endif %})
                            </span>
                        </div>
                        {% endif %}
                        
                        {% if rec.timeframe %}
                        <div><strong>Timeframe:</strong> {{ rec.timeframe }}</div>
                        {% endif %}
                        
                        {% if rec.reasoning %}
                        <div class="reasoning">{{ rec.reasoning }}</div>
                        {% endif %}
                        
                        <div class="timestamp">{{ rec.timestamp }}</div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-data">
                        No trading signals available. Start the bot to see analysis results.
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Risk Management Panel -->
        <div class="card">
            <h2>🛡️ Risk Management</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value">1.5%</div>
                    <div class="metric-label">Risk Per Trade</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">$245.67</div>
                    <div class="metric-label">Portfolio VaR</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">2.1x</div>
                    <div class="metric-label">Leverage</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">85%</div>
                    <div class="metric-label">Liquidity Score</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Modal -->
    <div id="logsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 800px; max-height: 80vh; overflow: auto;">
            <h2>Bot Logs</h2>
            <div id="logsContent" style="font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; margin: 15px 0;"></div>
            <div class="control-buttons">
                <button class="btn btn-secondary" onclick="closeLogs()" style="margin-right: 10px;">Close</button>
                <button class="btn btn-secondary" onclick="refreshLogs()">Refresh Logs</button>
                <button class="btn btn-secondary" onclick="clearLogs()">Clear Logs</button>
            </div>
        </div>
    </div>

    <!-- Risk Settings Modal -->
    <div id="riskModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 80vh; overflow: auto;">
            <h2>🛡️ Risk Management Settings</h2>
            <div style="margin: 20px 0;">
                <div style="margin-bottom: 15px;">
                    <label><strong>Risk Per Trade:</strong> 1.5%</label>
                    <input type="range" min="0.5" max="5" step="0.5" value="1.5" style="width: 100%; margin-top: 5px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label><strong>Max Portfolio Drawdown:</strong> 15%</label>
                    <input type="range" min="5" max="30" step="1" value="15" style="width: 100%; margin-top: 5px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label><strong>Stop-Loss Strategy:</strong> ATR-based</label>
                    <select style="width: 100%; padding: 8px; margin-top: 5px;">
                        <option>ATR-based</option>
                        <option>Percentage-based</option>
                        <option>Support/Resistance</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label><strong>Take-Profit Ratio:</strong> 1:2</label>
                    <select style="width: 100%; padding: 8px; margin-top: 5px;">
                        <option>1:1</option>
                        <option>1:2</option>
                        <option>1:3</option>
                    </select>
                </div>
            </div>
            <div class="control-buttons">
                <button class="btn btn-secondary" onclick="closeRiskSettings()" style="margin-right: 10px;">Cancel</button>
                <button class="btn btn-start" onclick="saveRiskSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        let performanceChart = null;
        let autoRefreshInterval = null;
        
        // Показ уведомления
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
        
        // Обновление дашборда
        async function updateDashboard() {
            try {
                console.log('Updating dashboard...');
                const response = await fetch('/api/status');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Обновляем статус
                updateStatus(data.status);
                
                // Обновляем цену
                updatePrice(data.current_price);
                
                // Обновляем статистику
                updateStatistics(data.performance);
                
                // Обновляем торговые метрики
                updateTradingMetrics(data.trading_metrics);
                
                // Обновляем время
                updateLastUpdate();
                
                // Обновляем рекомендации
                await updateRecommendations();
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
                showAlert('Error updating dashboard data: ' + error.message, 'error');
            }
        }
        
        function updateStatus(status) {
            const statusBadge = document.getElementById('statusBadge');
            const statusText = document.getElementById('statusText');
            if (statusBadge && statusText) {
                statusBadge.textContent = status;
                statusBadge.className = 'status-badge ' + 
                    (status === '🟢 RUNNING' ? 'status-running' : 'status-stopped');
                statusText.textContent = status;
            }
        }
        
        function updatePrice(price) {
            const priceElement = document.getElementById('currentPrice');
            if (priceElement && price) {
                priceElement.textContent = '$' + parseFloat(price).toFixed(2);
                priceElement.style.color = '#27ae60';
            }
        }
        
        function updateStatistics(performance) {
            if (performance && performance.total_recommendations > 0) {
                updatePerformanceChart(performance);
            }
        }
        
        function updateTradingMetrics(metrics) {
            if (metrics) {
                // Метрики уже отображаются из серверных данных
                console.log('Trading metrics updated:', metrics);
            }
        }
        
        function updateLastUpdate() {
            const lastUpdateElement = document.getElementById('lastUpdate');
            if (lastUpdateElement) {
                lastUpdateElement.textContent = new Date().toLocaleString();
            }
        }
        
        // Обновление рекомендаций
        async function updateRecommendations() {
            try {
                const response = await fetch('/api/recommendations?limit=10');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const recommendations = await response.json();
                
                const recommendationsList = document.getElementById('recommendationsList');
                if (recommendationsList) {
                    if (recommendations && recommendations.length > 0) {
                        recommendationsList.innerHTML = '';
                        recommendations.forEach((rec, index) => {
                            const strength = rec.confidence > 0.8 ? 'strong' : 
                                           rec.confidence > 0.6 ? 'medium' : 'weak';
                                           
                            const recElement = document.createElement('div');
                            recElement.className = `recommendation-item recommendation-${rec.action.toLowerCase()}`;
                            recElement.innerHTML = `
                                <div>
                                    <span class="action-badge action-${rec.action.toLowerCase()}">
                                        ${rec.action}
                                    </span>
                                    <span class="signal-strength strength-${strength}">
                                        ${strength.toUpperCase()}
                                    </span>
                                    <span class="signal-visual signal-${strength}-${rec.action.toLowerCase()}" id="signalVisual${index}">
                                        ${rec.action === 'BUY' ? 
                                            (strength === 'strong' ? '🟢🟢' : strength === 'medium' ? '🟢🟢🟢' : '🟢') :
                                         rec.action === 'SELL' ? 
                                            (strength === 'strong' ? '🔴🔴' : strength === 'medium' ? '🔴🔴🔴' : '🔴') :
                                         '⚪'}
                                    </span>
                                    <strong>Confidence: ${(rec.confidence * 100).toFixed(1)}%</strong>
                                    <span style="float: right;">$${rec.price ? rec.price.toFixed(2) : 'N/A'}</span>
                                </div>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: ${rec.confidence * 100}%;"></div>
                                </div>
                                ${rec.rsi ? `
                                <div><strong>RSI:</strong> ${rec.rsi.toFixed(2)} 
                                    <span style="color: ${rec.rsi < 30 ? '#28a745' : rec.rsi > 70 ? '#dc3545' : '#6c757d'}; font-weight: bold;">
                                        (${rec.rsi < 30 ? 'Oversold' : rec.rsi > 70 ? 'Overbought' : 'Neutral'})
                                    </span>
                                </div>` : ''}
                                ${rec.timeframe ? `<div><strong>Timeframe:</strong> ${rec.timeframe}</div>` : ''}
                                ${rec.reasoning ? `<div class="reasoning">${rec.reasoning}</div>` : ''}
                                <div class="timestamp">${rec.timestamp}</div>
                            `;
                            recommendationsList.appendChild(recElement);
                        });
                    } else {
                        recommendationsList.innerHTML = '<div class="no-data">No trading signals available. Start the bot to see analysis results.</div>';
                    }
                }
            } catch (error) {
                console.error('Error updating recommendations:', error);
            }
        }
        
        // Обновление графика производительности
        function updatePerformanceChart(performance) {
            const ctx = document.getElementById('performanceChart');
            if (!ctx) return;
            
            const chartCtx = ctx.getContext('2d');
            
            if (performanceChart) {
                performanceChart.destroy();
            }
            
            performanceChart = new Chart(chartCtx, {
                type: 'doughnut',
                data: {
                    labels: ['BUY', 'SELL', 'HOLD'],
                    datasets: [{
                        data: [
                            performance.buy_percentage || 0,
                            performance.sell_percentage || 0, 
                            performance.hold_percentage || 0
                        ],
                        backgroundColor: [
                            '#28a745',
                            '#dc3545',
                            '#ffc107'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Запуск бота
        async function startBot() {
            const startBtn = document.getElementById('startBtn');
            const startBtn2 = document.getElementById('startBtn2');
            
            // Визуальная обратная связь
            startBtn.disabled = true;
            startBtn2.disabled = true;
            startBtn.innerHTML = '<div class="loading-spinner"></div> Starting...';
            startBtn2.innerHTML = '<div class="loading-spinner"></div> Starting...';
            
            showAlert('Starting trading bot with risk management...', 'info');
            
            try {
                const response = await fetch('/api/start_bot', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                showAlert(data.message, data.status);
                
                // Обновляем статус после запуска
                setTimeout(() => {
                    updateDashboard();
                    startBtn.disabled = false;
                    startBtn2.disabled = false;
                    startBtn.innerHTML = '▶ Start Trading Bot';
                    startBtn2.innerHTML = '▶ Start Trading';
                }, 3000);
                
            } catch (error) {
                console.error('Error starting bot:', error);
                showAlert('Error starting bot: ' + error.message, 'error');
                startBtn.disabled = false;
                startBtn2.disabled = false;
                startBtn.innerHTML = '▶ Start Trading Bot';
                startBtn2.innerHTML = '▶ Start Trading';
            }
        }
        
        // Остановка бота
        async function stopBot() {
            const stopBtn = document.getElementById('stopBtn');
            const stopBtn2 = document.getElementById('stopBtn2');
            
            stopBtn.disabled = true;
            stopBtn2.disabled = true;
            stopBtn.innerHTML = '<div class="loading-spinner"></div> Stopping...';
            stopBtn2.innerHTML = '<div class="loading-spinner"></div> Stopping...';
            
            showAlert('Stopping trading bot and closing positions...', 'info');
            
            try {
                const response = await fetch('/api/stop_bot', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                showAlert(data.message, data.status);
                
                // Обновляем статус после остановки
                setTimeout(() => {
                    updateDashboard();
                    stopBtn.disabled = false;
                    stopBtn2.disabled = false;
                    stopBtn.innerHTML = '⏹ Stop Trading Bot';
                    stopBtn2.innerHTML = '⏹ Stop Trading';
                }, 2000);
                
            } catch (error) {
                console.error('Error stopping bot:', error);
                showAlert('Error stopping bot: ' + error.message, 'error');
                stopBtn.disabled = false;
                stopBtn2.disabled = false;
                stopBtn.innerHTML = '⏹ Stop Trading Bot';
                stopBtn2.innerHTML = '⏹ Stop Trading';
            }
        }
        
        // Принудительное обновление данных
        async function forceRefresh() {
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshBtn2 = document.getElementById('refreshBtn2');
            
            refreshBtn.disabled = true;
            refreshBtn2.disabled = true;
            refreshBtn.innerHTML = '<div class="loading-spinner"></div> Refreshing...';
            refreshBtn2.innerHTML = '<div class="loading-spinner"></div> Refreshing...';
            
            try {
                // Отправляем запрос на принудительное обновление
                const response = await fetch('/api/force_refresh', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    showAlert('Data refresh triggered successfully', 'success');
                }
                
                // Обновляем данные
                await updateDashboard();
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                showAlert('Error refreshing data: ' + error.message, 'error');
            } finally {
                setTimeout(() => {
                    refreshBtn.disabled = false;
                    refreshBtn2.disabled = false;
                    refreshBtn.innerHTML = '🔄 Refresh Data';
                    refreshBtn2.innerHTML = '🔄 Refresh Data';
                }, 1000);
            }
        }
        
        // Показ логов
        async function showLogs() {
            try {
                const response = await fetch('/api/bot_logs');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                const logsContent = document.getElementById('logsContent');
                if (logsContent) {
                    logsContent.innerHTML = '';
                    
                    if (data.logs && data.logs.length > 0) {
                        data.logs.forEach(log => {
                            const logLine = document.createElement('div');
                            logLine.textContent = log;
                            logsContent.appendChild(logLine);
                        });
                        // Прокрутка к нижней части
                        logsContent.scrollTop = logsContent.scrollHeight;
                    } else {
                        logsContent.textContent = 'No logs available. Start the bot to generate logs.';
                    }
                }
                
                document.getElementById('logsModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading logs:', error);
                showAlert('Error loading logs: ' + error.message, 'error');
            }
        }
        
        // Показ настроек риска
        function showRiskSettings() {
            document.getElementById('riskModal').style.display = 'block';
        }
        
        // Закрытие настроек риска
        function closeRiskSettings() {
            document.getElementById('riskModal').style.display = 'none';
        }
        
        // Сохранение настроек риска
        function saveRiskSettings() {
            showAlert('Risk management settings saved successfully', 'success');
            closeRiskSettings();
        }
        
        // Обновление логов
        async function refreshLogs() {
            try {
                const response = await fetch('/api/bot_logs');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                const logsContent = document.getElementById('logsContent');
                if (logsContent) {
                    logsContent.innerHTML = '';
                    
                    if (data.logs && data.logs.length > 0) {
                        data.logs.forEach(log => {
                            const logLine = document.createElement('div');
                            logLine.textContent = log;
                            logsContent.appendChild(logLine);
                        });
                        // Прокрутка к нижней части
                        logsContent.scrollTop = logsContent.scrollHeight;
                    } else {
                        logsContent.textContent = 'No logs available.';
                    }
                }
            } catch (error) {
                console.error('Error refreshing logs:', error);
                showAlert('Error refreshing logs: ' + error.message, 'error');
            }
        }
        
        // Очистка логов
        async function clearLogs() {
            if (confirm('Are you sure you want to clear the logs? This action cannot be undone.')) {
                const logsContent = document.getElementById('logsContent');
                if (logsContent) {
                    logsContent.innerHTML = 'Logs cleared. New logs will appear when the bot runs.';
                }
                showAlert('Logs cleared successfully', 'success');
            }
        }
        
        // Закрытие модального окна логов
        function closeLogs() {
            document.getElementById('logsModal').style.display = 'none';
        }
        
        // Запуск авто-обновления
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            autoRefreshInterval = setInterval(updateDashboard, 5000); // Обновление каждые 5 секунд
        }
        
        // Остановка авто-обновления
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // Первоначальная загрузка и настройка
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initialized');
            
            // Запускаем авто-обновление
            startAutoRefresh();
            
            // Первоначальное обновление данных
            updateDashboard();
            
            // Инициализация графика если есть данные
            {% if stats and stats.total_recommendations > 0 %}
            updatePerformanceChart({{ stats | tojson }});
            {% endif %}
            
            // Обработка закрытия страницы
            window.addEventListener('beforeunload', function() {
                stopAutoRefresh();
            });
        });
    </script>
</body>
</html>